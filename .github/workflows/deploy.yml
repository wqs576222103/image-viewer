name: Deploy to Server
on:
  push:
    branches: [master-build]

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 129.28.44.109
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e  # 遇到错误立即退出
            echo "=== 开始部署 ==="

            echo "1. 进入项目目录..."
            cd ~/image-viewer

            echo "2. 拉取最新代码..."
            git pull origin main

            echo "3. 重新构建并启动容器..."
            docker-compose up --build -d

            echo "4. 查看容器状态..."
            docker-compose ps

            echo "5. 查看最新日志..."
            docker-compose logs --tail=50

            echo "=== 部署完成 ==="
